# Use CUDA 12.4.1 base image for RTX 4090 compatibility
FROM nvidia/cuda:12.4.1-base-ubuntu22.04

# Set environment variables
ENV PYTHONUNBUFFERED=1
ENV DEBIAN_FRONTEND=noninteractive
ENV IMAGEIO_FFMPEG_EXE=/usr/bin/ffmpeg
ENV CUDA_HOME=/usr/local/cuda
ENV PATH=$PATH:$CUDA_HOME/bin
ENV LD_LIBRARY_PATH=/usr/local/cuda/lib64

# Install system dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends software-properties-common \
    gpg-agent \
    && add-apt-repository ppa:deadsnakes/ppa && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
    git \
    make \
    wget \
    curl \
    unzip \
    pkg-config \
    ca-certificates \
    build-essential \
    python3.12 \
    python3.12-venv \
    python3.12-dev \
    libglx-mesa0 \
    libglib2.0-0 \
    libsm6 \
    libxext6 \
    libxrender-dev \
    libgomp1 \
    ffmpeg \
    openssh-server \
    openssh-client \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Install pip for Python 3.12 manually
RUN curl -sS https://bootstrap.pypa.io/get-pip.py -o get-pip.py && \
    python3.12 get-pip.py && \
    python3.12 -m pip install --upgrade pip && \
    rm get-pip.py

# CUDA toolkit and cuDNN already included in nvidia/cuda base image

# CUDA toolkit and cuDNN already included in nvidia/cuda base image

# Configure SSH for root login
RUN sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config && \
    sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config && \
    mkdir -p /run/sshd && \
    rm -f /etc/ssh/ssh_host_*

# Create virtual environment to avoid externally-managed-environment error
RUN python3.12 -m venv /opt/comfyui-env && \
    /opt/comfyui-env/bin/pip install --upgrade pip

# Install PyTorch with CUDA 12.4.1 (matching base image)
RUN /opt/comfyui-env/bin/pip install --no-cache-dir torch torchvision --index-url https://download.pytorch.org/whl/cu124

# Remove uv to force ComfyUI-Manager to use pip (uv doesn't respect --system-site-packages properly)
RUN pip uninstall -y uv 2>/dev/null || true && \
    rm -f /usr/local/bin/uv /usr/local/bin/uvx

# Install ComfyUI latest stable version
WORKDIR /ComfyUI
RUN git clone https://github.com/comfyanonymous/ComfyUI.git . && \
    /opt/comfyui-env/bin/pip install --no-cache-dir -r requirements.txt && \
    /opt/comfyui-env/bin/pip install --no-cache-dir GitPython opencv-python

# Install llama-cpp-python for GGUF support (CUDA 12.4 compatible with base image)
RUN /opt/comfyui-env/bin/pip install --upgrade --force-reinstall --no-cache-dir \
    https://github.com/JamePeng/llama-cpp-python/releases/download/v0.3.27-cu124-Basic-linux-20260222/llama_cpp_python-0.3.27+cu124.basic-cp312-cp312-linux_x86_64.whl

# Install ALL ComfyUI custom nodes from VastAI provisioning + RunpodDirect
RUN cd /ComfyUI/custom_nodes && \
    git clone https://github.com/ltdrdata/ComfyUI-Manager.git && \
    git clone https://github.com/cubiq/ComfyUI_essentials.git && \
    git clone https://github.com/huchukato/comfy-tagcomplete.git && \
    git clone https://github.com/huchukato/ComfyUI-QwenVL-Mod.git && \
    git clone https://github.com/huchukato/ComfyUI-RIFE-TensorRT-Auto.git && \
    git clone https://github.com/huchukato/ComfyUI-HuggingFace.git && \
    git clone https://github.com/MadiatorLabs/ComfyUI-RunpodDirect.git && \
    git clone https://github.com/city96/ComfyUI-GGUF.git && \
    git clone https://github.com/ltdrdata/ComfyUI-Impact-Pack.git && \
    git clone https://github.com/MoonGoblinDev/Civicomfy.git && \
    git clone https://github.com/Koishi-Star/Euler-Smea-Dyn-Sampler.git && \
    git clone https://github.com/ltdrdata/was-node-suite-comfyui.git && \
    git clone https://github.com/Kosinkadink/ComfyUI-VideoHelperSuite.git && \
    git clone https://github.com/rgthree/rgthree-comfy.git && \
    git clone https://github.com/yolain/ComfyUI-Easy-Use.git && \
    git clone https://github.com/kijai/ComfyUI-KJNodes.git && \
    git clone https://github.com/Fannovel16/ComfyUI-Frame-Interpolation.git && \
    git clone https://github.com/Smirnov75/ComfyUI-mxToolkit.git && \
    git clone https://github.com/princepainter/ComfyUI-PainterI2V.git && \
    git clone https://github.com/princepainter/ComfyUI-PainterI2Vadvanced.git && \
    git clone https://github.com/princepainter/ComfyUI-PainterLongVideo.git && \
    git clone https://github.com/ashtar1984/comfyui-find-perfect-resolution.git && \
    git clone https://github.com/ComfyAssets/ComfyUI_Selectors.git && \
    git clone https://github.com/kijai/ComfyUI-MMAudio.git && \
    git clone https://github.com/GACLove/ComfyUI-VFI.git && \
    git clone https://github.com/yuvraj108c/ComfyUI-Upscaler-Tensorrt.git && \
    git clone https://github.com/stduhpf/ComfyUI-WanMoeKSampler.git && \
    git clone https://github.com/melMass/comfy_mtb.git

# Copy wildcards to Impact-Pack (required for wildcard workflows)
RUN cp -r /ComfyUI/custom_nodes/comfy-tagcomplete/wildcards/mbe /ComfyUI/custom_nodes/ComfyUI-Impact-Pack/wildcards || echo "Wildcards copy completed (or already exists)"

# Install requirements for all custom nodes
RUN bash -c 'cd /ComfyUI/custom_nodes && for node_dir in */; do if [ -f "$node_dir/requirements.txt" ]; then echo "Installing requirements for $node_dir..." && /opt/comfyui-env/bin/pip install --no-cache-dir -r "$node_dir/requirements.txt" || echo "Failed to install requirements for $node_dir"; fi; done'

# Install additional essential dependencies
RUN /opt/comfyui-env/bin/pip install --no-cache-dir jupyter sageattention

# Clean up heavy Git files to save space (keep repo structure for updates)
RUN find /ComfyUI/custom_nodes -name ".git" -type d -exec find {} -name "*.pack" -delete + || true && \
    find /ComfyUI/custom_nodes -name ".git" -type d -exec find {} -name "pack-*.idx" -delete + || true && \
    find /ComfyUI/custom_nodes -name ".git" -type d -exec find {} -name "objects" -type d -exec rm -rf {} + || true

# Create FileBrowser (RunPod method)
RUN curl -fsSL https://raw.githubusercontent.com/filebrowser/get/master/get.sh | bash

# Create FileBrowser database and directories
RUN mkdir -p /filebrowser && \
    mkdir -p /filebrowser/database && \
    mkdir -p /filebrowser/files && \
    ln -sf /ComfyUI /filebrowser/files/ComfyUI && \
    echo '{"port": 8080, "baseURL": "", "address": "0.0.0.0", "log": "stdout", "database": "/filebrowser/database/filebrowser.db", "root": "/filebrowser/files", "noauth": true}' > /filebrowser/.config.json

# Create FileBrowser startup script
RUN echo '#!/bin/bash\n\
echo "ğŸ“ Starting FileBrowser on port 8080"\n\
echo "ğŸŒ Access at: http://0.0.0.0:8080"\n\
echo "ğŸ‘¤ No authentication required"\n\
echo ""\n\
cd /filebrowser\n\
filebrowser --config /filebrowser/.config.json\n\
' > /usr/local/bin/start-filebrowser.sh && chmod +x /usr/local/bin/start-filebrowser.sh

# Create Jupyter Lab startup script
RUN cat > /usr/local/bin/start-jupyter.sh << 'EOF'
#!/bin/bash
echo "ğŸ““ Starting Jupyter Lab on port 8888"
echo "ğŸŒ Access at: http://0.0.0.0:8888"
echo "ğŸ”‘ No token required"
echo ""
cd /ComfyUI
echo "ğŸ”§ Starting Jupyter Lab with terminal support..."
/opt/comfyui-env/bin/nohup jupyter lab \
    --allow-root \
    --no-browser \
    --port=8888 \
    --ip=0.0.0.0 \
    --FileContentsManager.delete_to_trash=False \
    --FileContentsManager.preferred_dir=/ComfyUI \
    --ServerApp.root_dir=/ComfyUI \
    --ServerApp.terminado_settings='{"shell_command":["/bin/bash"]}' \
    --IdentityProvider.token="" \
    --ServerApp.allow_origin=* &> /jupyter.log &
echo "âœ… Jupyter Lab started"
echo "ğŸ” Checking Jupyter Lab status..."
sleep 5
if pgrep -f "jupyter lab" > /dev/null; then
    echo "âœ… Jupyter Lab started successfully"
    echo "ğŸ“Š Jupyter Lab logs:"
    tail -10 /jupyter.log
else
    echo "âŒ Jupyter Lab failed to start"
    echo "ğŸ“Š Full error logs:"
    cat /jupyter.log
    echo "ğŸ” Checking what went wrong..."
    echo "ğŸ Python version in virtual env:"
    /opt/comfyui-env/bin/python --version
    echo "ğŸ“¦ Jupyter Lab version in virtual env:"
    /opt/comfyui-env/bin/jupyter lab --version
fi
EOF
RUN chmod +x /usr/local/bin/start-jupyter.sh

# Create user directory structure
RUN mkdir -p /ComfyUI/user/default/workflows

# Create models directories
RUN mkdir -p /ComfyUI/models/vae && \
    mkdir -p /ComfyUI/models/upscale_models && \
    mkdir -p /ComfyUI/models/text_encoders

# Clean up heavy Git files to save space (keep repo structure for updates)
RUN find /ComfyUI/custom_nodes -name ".git" -type d -exec find {} -name "*.pack" -delete + || true && \
    find /ComfyUI/custom_nodes -name ".git" -type d -exec find {} -name "pack-*.idx" -delete + || true && \
    find /ComfyUI/custom_nodes -name ".git" -type d -exec find {} -name "objects" -type d -exec rm -rf {} + || true

# Aggressive cleanup to reduce image size
RUN rm -rf /tmp/* \
       && rm -rf /var/lib/apt/lists/* \
       && rm -rf /var/cache/apt/archives/* \
       && find /ComfyUI -name "*.pyc" -delete \
       && find /ComfyUI -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true

# Set ComfyUI arguments (optimized for WAN2.2 with SageAttention)
ENV COMFYUI_ARGS="--listen 0.0.0.0 --port 8188 --disable-auto-launch --enable-cors-header --fast fp16_accumulation --use-sage-attention --reserve-vram 2 --cuda-malloc --async-offload"

# Create startup script (RunPod style with dynamic workflow updates)
RUN cat > /ComfyUI/start.sh << 'EOF'
#!/bin/bash
set -e  # Exit the script if any statement returns a non-true return value

COMFYUI_DIR="/ComfyUI"
FILEBROWSER_CONFIG="/filebrowser/.config.json"
DB_FILE="/filebrowser/database/filebrowser.db"

# Function to download latest workflows
update_workflows() {
    echo "ğŸ”„ Updating workflows from latest versions..."
    mkdir -p /ComfyUI/user/default/workflows
    cd /ComfyUI/user/default/workflows
    
    # List of latest workflows
    workflows=(
        "PMP-LoRaStack-Upscale-Wildcards.json"
        "WAN2.2-I2V-AutoPrompt-Story.json"
        "WAN2.2-T2V-AutoPrompt-Story.json"
        "Wan2.2-I2V-SVI-AutoPrompt-Story.json"
        "WAN2.2-I2V-AutoPrompt.json"
        "WAN2.2-I2V-AutoPrompt-GGUF.json"
        "WAN2.2-T2V-AutoPrompt.json"
        "WAN2.2-T2V-AutoPrompt-GGUF.json"
        "Wan2.2-I2V-SVI-AutoPrompt.json"
        "Wan2.2-I2V-SVI-AutoPrompt-GGUF.json"
        "WAN2.2-I2V-Full-AutoPrompt-MMAudio.json"
        "WAN2.2-I2V-Full-AutoPrompt-MMAudio-GGUF.json"
        "WAN2.2-T2V-I2V-Full-AutoPrompt-MMAudio-GGUF.json"
    )
    
    for workflow in "${workflows[@]}"; do
        echo "  ğŸ“¥ Downloading: $workflow"
        wget -q "https://github.com/huchukato/ComfyUI-QwenVL-Mod/raw/main/vastai/workflows/$workflow" -O "$workflow" || echo "  âš ï¸ Failed to download $workflow"
    done
    
    echo "âœ… Workflow update completed"
}

download_models() {
    echo "ğŸ”„ Downloading essential models..."
    cd /ComfyUI
    
    # Download VAE models
    if [ ! -f "/ComfyUI/models/vae/wan_2.1_vae.safetensors" ]; then
        echo "  ğŸ“¥ Downloading WAN 2.1 VAE..."
        wget -q "https://huggingface.co/Comfy-Org/Wan_2.2_ComfyUI_Repackaged/resolve/main/split_files/vae/wan_2.1_vae.safetensors" -O "/ComfyUI/models/vae/wan_2.1_vae.safetensors" || echo "  âš ï¸ Failed to download WAN 2.1 VAE"
    fi
    
        
    if [ ! -f "/ComfyUI/models/vae/sdxl_vae.safetensors" ]; then
        echo "  ğŸ“¥ Downloading SDXL VAE..."
        wget -q "https://huggingface.co/huchukato/favs/resolve/main/VAE/sdxl.vae.safetensors" -O "/ComfyUI/models/vae/sdxl_vae.safetensors" || echo "  âš ï¸ Failed to download SDXL VAE"
    fi
    
    # Download upscale models
    if [ ! -f "/ComfyUI/models/upscale_models/2xLexicaRRDBNet.pth" ]; then
        echo "  ğŸ“¥ Downloading 2xLexicaRRDBNet upscale model..."
        wget -q "https://huggingface.co/huchukato/favs/resolve/main/ESRGAN/2xLexicaRRDBNet.pth" -O "/ComfyUI/models/upscale_models/2xLexicaRRDBNet.pth" || echo "  âš ï¸ Failed to download upscale model"
    fi
    
    if [ ! -f "/ComfyUI/models/upscale_models/2xLexicaRRDBNet_Sharp.pth" ]; then
        echo "  ğŸ“¥ Downloading 2xLexicaRRDBNet Sharp upscale model..."
        wget -q "https://huggingface.co/huchukato/favs/resolve/main/ESRGAN/2xLexicaRRDBNet_Sharp.pth" -O "/ComfyUI/models/upscale_models/2xLexicaRRDBNet_Sharp.pth" || echo "  âš ï¸ Failed to download Sharp upscale model"
    fi
    
    # Download text encoder
    if [ ! -f "/ComfyUI/models/text_encoders/nsfw_wan_umt5-xxl_fp8_scaled.safetensors" ]; then
        echo "  ğŸ“¥ Downloading NSFW WAN UMT5-XXL text encoder..."
        wget -q "https://huggingface.co/NSFW-API/NSFW-Wan-UMT5-XXL/resolve/main/nsfw_wan_umt5-xxl_fp8_scaled.safetensors" -O "/ComfyUI/models/text_encoders/nsfw_wan_umt5-xxl_fp8_scaled.safetensors" || echo "  âš ï¸ Failed to download text encoder"
    fi
    
        
    echo "âœ… Model download completed"
    echo "ğŸ“‹ Available models:"
    ls -la /ComfyUI/models/vae/
    ls -la /ComfyUI/models/upscale_models/
    ls -la /ComfyUI/models/text_encoders/
}

echo "ğŸš€ Starting ComfyUI-QwenVL-Mod on RunPod (RTX 4090 Version)"
echo "ğŸ¬ WAN 2.2 workflows ready"
echo "ğŸŒ Multilingual support enabled"
echo "ğŸ¨ Visual style detection ready"
echo "âš¡ GGUF backend optimized"
echo ""

# Update workflows to latest versions
update_workflows

# Download essential models
download_models

echo "ğŸ”§ Services starting:"
echo "ğŸ“ FileBrowser: http://0.0.0.0:8080"
echo "ğŸ““ Jupyter Lab:  http://0.0.0.0:8888 (Terminal included)"
echo "ğŸ¨ ComfyUI:    http://0.0.0.0:8188"
echo "ğŸ“‹ Available workflows:"
ls -la /ComfyUI/user/default/workflows/
echo ""
echo "ğŸ’¡ Models pre-loaded for immediate use"
echo ""

# Start FileBrowser
echo "ğŸ”§ Starting FileBrowser..."
nohup /usr/local/bin/start-filebrowser.sh &> /filebrowser.log &
echo "âœ… FileBrowser started"

# Start Jupyter Lab
echo "ğŸ”§ Starting Jupyter Lab..."
nohup /usr/local/bin/start-jupyter.sh &> /jupyter.log &
sleep 5
echo "ğŸ” Checking Jupyter Lab status..."
if pgrep -f "jupyter lab" > /dev/null; then
    echo "âœ… Jupyter Lab started successfully"
    echo "ğŸ“Š Jupyter Lab logs:"
    tail -10 /jupyter.log
else
    echo "âŒ Jupyter Lab failed to start"
    echo "ğŸ“Š Full error logs:"
    cat /jupyter.log
    echo "ğŸ” Checking what went wrong..."
    echo "ğŸ Python version in virtual env:"
    /opt/comfyui-env/bin/python --version
    echo "ğŸ“¦ Jupyter Lab version in virtual env:"
    /opt/comfyui-env/bin/jupyter lab --version
fi

# Start ComfyUI
echo "ğŸš€ Starting ComfyUI..."
echo "ğŸŒ ComfyUI will be available at: http://0.0.0.0:$(echo $COMFYUI_ARGS | grep -oP '(?<=--port\s)\d+' || echo '8188')"
echo "ğŸ““ Jupyter Lab Terminal: Open http://0.0.0.0:8888 â†’ New â†’ Terminal"
cd $COMFYUI_DIR
/opt/comfyui-env/bin/nohup python main.py $COMFYUI_ARGS &> /comfyui.log &
echo "âœ… ComfyUI started"

# Tail the ComfyUI log
tail -f /comfyui.log
EOF
RUN chmod +x /ComfyUI/start.sh

# Set working directory
WORKDIR /ComfyUI

# Expose ports
EXPOSE 8080 8188 8888 22

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://0.0.0.0:8188/system_stats || exit 1

# Start ComfyUI
CMD ["/ComfyUI/start.sh"]
